<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <meta name="description" content=""> 
  
  <!-- the favicon -->
  <link rel="icon" type="image/png" href="http://localhost:4000/images/favicon/complexcity.png" />			
  <link rel="icon" type="image/x-icon" href="http://localhost:4000/images/favicon/complexcity.ico" />
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/images/favicon/complexcity-retina.png" />
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000images/favicon/complexcity-ipad.png" />
  <link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/favicon/complexcity-iphone.png" />

  <!-- the style -->
  <link rel="stylesheet" href="/css/style.css" />

  
  <link rel="stylesheet" href="/css/syntax.css" />
	
	
  <!-- the scripts -->
  <script src="/scripts/jquery-1.11.1.min.js"></script>
  <script src="/scripts/responsiveslides.min.js"></script>
  <script src="/scripts/complexcity.js"></script>
  <script src="/scripts/Autolinker.min.js"></script>
  <script src="/scripts/jquery.equalheights.min.js"></script>

  

  
		
  <!--[if lt IE 9]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <!-- the title -->
  <title>Weido spatial and temporal data explained</title>  
  
</head>
<body>

	<div class="invert-header-color" style="margin:0; width:100%;">
	<header class="header clearfix container">
      <!-- the LOGO -->
      <div class="logo">
      	<a href="http://localhost:4000" alt="Complexcity Lab home" title="go home">
      		<img src="http://localhost:4000/images/logo-ComplexCity-white.svg" onerror="this.onerror=null; this.src='images/logo-ComplexCity.png'" class="img-logo" alt="ComplexCity is a Sino-French joint lab program" ></a>
	    	</a>
	  	</div>

 	  	<!-- the SOCIAL links -->
	  	<div id="social">
				 <a href="https://github.com/ComplexCity/" title="our github repository" target="_blank">
					 <img src="http://localhost:4000/images/follow-us-github-white.svg" onmouseover="this.src='http://localhost:4000/images/follow-us-github-hover.svg'" onmouseout="this.src='http://localhost:4000/images/follow-us-github-white.svg'" /></a>
				 <a href="https://speakerdeck.com/complexcity" title="our presentations on speakerdeck" target="_blank">
					 <img src="http://localhost:4000/images/follow-us-speakerdeck-white.svg" onmouseover="this.src='http://localhost:4000/images/follow-us-speakerdeck-hover.svg'" onmouseout="this.src='http://localhost:4000/images/follow-us-speakerdeck-white.svg'" /></a>
				 <a href="http://twitter.com/complexcity_lab" title="our twitter account" target="_blank">
					 <img src="http://localhost:4000/images/follow-us-twitter-white.svg" onmouseover="this.src='http://localhost:4000/images/follow-us-twitter-hover.svg'" onmouseout="this.src='http://localhost:4000/images/follow-us-twitter-white.svg'"/></a>
				 <a href="http://www.weibo.com/complexcity" title="our weibo account" target=_blank>
					 <img src="http://localhost:4000/images/follow-us-weibo-white.svg" onmouseover="this.src='http://localhost:4000/images/follow-us-weibo-hover.svg'" onmouseout="this.src='http://localhost:4000/images/follow-us-weibo-white.svg'"/></a>
				 <a href="/blog/feed.xml" title="ComplexCity Lab's Blog RSS feed" target=_blank>
					 <img src="http://localhost:4000/images/follow-us-syndication-white.svg" onmouseover="this.src='http://localhost:4000/images/follow-us-syndication-hover.svg'" onmouseout="this.src='http://localhost:4000/images/follow-us-syndication-white.svg'"/></a>
				 <a href="https://pinboard.in/u:shangdaemon/public/" title="our web links" target=_blank>
					 <img src="http://localhost:4000/images/follow-us-pinboard-white.svg" onmouseover="this.src='http://localhost:4000/images/follow-us-pinboard-hover.svg'" onmouseout="this.src='http://localhost:4000/images/follow-us-pinboard-white.svg'"/></a>
				 <a href="https://www.goodreads.com/review/list/32004943?shelf=read" title="the books we like" target=_blank>
					 <img src="http://localhost:4000/images/follow-us-goodreads-white.svg" onmouseover="this.src='http://localhost:4000/images/follow-us-goodreads-hover.svg'" onmouseout="this.src='http://localhost:4000/images/follow-us-goodreads-white.svg'"/></a>
			</div>

      <!--the MENU -->
      <nav class="menu_main">
        <ul>
          <li><a href="/about/">ABOUT</a></li>
          <li><a href="/projects/">PROJECTS</a></li>
          <li><a href="/studies/">STUDIES</a></li>
          <li class="active"><a href="/blog/">BLOG</a></li>
        </ul>
      </nav>
            
      <!-- credit work in the top corner, image in css -->
    </header>
    </div>

	<article class="article clearfix" style="padding-top:3em;">
		<h1 class="col_100 thin center"> Weido spatial and temporal data explained </h1>
		<p class="thin center">By <a href="/authors/laetitia-pfaender/" title="Posts by Laëtitia Pfaender" class="underline-hover">Laëtitia Pfaender ()</a> on 02 Jun 2014</p>
		<p><img class="clearfix blog-img-full-size" alt="Weibo data over the map of Shanghai" src="/assets/weibo-spatial-and-temporal-data/big.png" /></p>
		<div class="blog-container">
			<p>The following post goes along with the article <a href="/studies/">Weibo spatial and temporal data</a>. The visualization was built on two JavaScript libraries: <a href="http://d3js.org">D3.js</a> for the bar chart and <a href="http://mapbox.com">Mapbox.js</a> for the map. The purpose of this tutorial is to explain the technical side and hence give a practical example around these two libraries. It assumes you know a little about web development though: how to edit a web page and view it in your browser, how to include JavaScript on the page and the like.</p>

<h2 id="the_data">The data</h2>

<p>For the <a href="/projects/">Digital Eternity Project</a>, we queried the Weibo API with a Python script using a tessellation of Shanghai made with 4 km diameter cells centered on 85 locations. Thus, we collected about 245,000 messages created between April 1 and April 9. These messages were stored into a SQLite database. Then, another Python script was in charge of counting the messages. The result is a JavaScript dictionary (or associative array) associating the number of messages at the 24 hours of the day to each of the 85 GPS coordinates:</p>
<div class='highlight'><pre><code class='javascript'><span class='kd'>var</span> <span class='nx'>weibo</span> <span class='o'>=</span> <span class='p'>{</span>
  <span class='s1'>&#39;31.254200, 121.532400&#39;</span><span class='o'>:</span> <span class='p'>[</span><span class='mi'>88</span><span class='p'>,</span> <span class='mi'>37</span><span class='p'>,</span> <span class='mi'>19</span><span class='p'>,</span> <span class='mi'>12</span><span class='p'>,</span> <span class='mi'>9</span><span class='p'>,</span> <span class='mi'>11</span><span class='p'>,</span> <span class='mi'>35</span><span class='p'>,</span> <span class='mi'>47</span><span class='p'>,</span> <span class='mi'>80</span><span class='p'>,</span> <span class='mi'>103</span><span class='p'>,</span> <span class='mi'>74</span><span class='p'>,</span> <span class='mi'>71</span><span class='p'>,</span> <span class='mi'>73</span><span class='p'>,</span> <span class='mi'>87</span><span class='p'>,</span> <span class='mi'>70</span><span class='p'>,</span> <span class='mi'>54</span><span class='p'>,</span> <span class='mi'>80</span><span class='p'>,</span> <span class='mi'>71</span><span class='p'>,</span> <span class='mi'>101</span><span class='p'>,</span> <span class='mi'>117</span><span class='p'>,</span> <span class='mi'>152</span><span class='p'>,</span> <span class='mi'>168</span><span class='p'>,</span> <span class='mi'>180</span><span class='p'>,</span> <span class='mi'>141</span><span class='p'>],</span>
  <span class='err'>…</span>
  <span class='s1'>&#39;31.308200, 121.511400&#39;</span><span class='o'>:</span> <span class='p'>[</span><span class='mi'>261</span><span class='p'>,</span> <span class='mi'>96</span><span class='p'>,</span> <span class='mi'>47</span><span class='p'>,</span> <span class='mi'>36</span><span class='p'>,</span> <span class='mi'>12</span><span class='p'>,</span> <span class='mi'>23</span><span class='p'>,</span> <span class='mi'>76</span><span class='p'>,</span> <span class='mi'>114</span><span class='p'>,</span> <span class='mi'>150</span><span class='p'>,</span> <span class='mi'>226</span><span class='p'>,</span> <span class='mi'>196</span><span class='p'>,</span> <span class='mi'>255</span><span class='p'>,</span> <span class='mi'>251</span><span class='p'>,</span> <span class='mi'>263</span><span class='p'>,</span> <span class='mi'>294</span><span class='p'>,</span> <span class='mi'>224</span><span class='p'>,</span> <span class='mi'>303</span><span class='p'>,</span> <span class='mi'>311</span><span class='p'>,</span> <span class='mi'>332</span><span class='p'>,</span> <span class='mi'>350</span><span class='p'>,</span> <span class='mi'>338</span><span class='p'>,</span> <span class='mi'>325</span><span class='p'>,</span> <span class='mi'>303</span><span class='p'>,</span> <span class='mi'>345</span><span class='p'>]</span>
<span class='p'>};</span>
</code></pre></div>
<p>So, for example, the number of messages created in the cell centered in (31.254200, 121.532400) between 3 and 4 am is given by <code class='highlight'><span class='nx'>weibo</span><span class='p'>[</span><span class='s1'>&#39;31.254200, 121.532400&#39;</span><span class='p'>]</span><span class='p'>[</span><span class='mi'>3</span><span class='p'>]</span></code>.</p>

<p>This variable is stored in the external file weibo.js.</p>

<h2 id="the_code">The code</h2>

<p>The full code for the visualization can be found on <a href="https://github.com/ComplexCity/weibo-qingmingjie">GitHub</a> but globally it looks like:</p>
<div class='highlight'><pre><code class='html'><span class='cp'>&lt;!doctype html&gt;</span>
<span class='nt'>&lt;html&gt;</span>
<span class='nt'>&lt;head&gt;</span>
  <span class='nt'>&lt;meta</span> <span class='na'>charset=</span><span class='s'>&quot;utf-8&quot;</span> <span class='nt'>/&gt;</span>
  <span class='nt'>&lt;title&gt;</span>Weibo messages during QingMing Jie<span class='nt'>&lt;/title&gt;</span>
  
  <span class='c'>&lt;!-- prepare and load everything for Mapbox --&gt;</span>
  <span class='nt'>&lt;meta</span> <span class='na'>name=</span><span class='s'>&quot;viewport&quot;</span> <span class='na'>content=</span><span class='s'>&quot;initial-scale=1,maximum-scale=1,user-scalable=no&quot;</span> <span class='nt'>/&gt;</span>
  <span class='nt'>&lt;script </span><span class='na'>src=</span><span class='s'>&quot;https://api.tiles.mapbox.com/mapbox.js/v1.6.3/mapbox.js&quot;</span><span class='nt'>&gt;&lt;/script&gt;</span>
  <span class='nt'>&lt;link</span> <span class='na'>href=</span><span class='s'>&quot;https://api.tiles.mapbox.com/mapbox.js/v1.6.3/mapbox.css&quot;</span> <span class='na'>rel=</span><span class='s'>&quot;stylesheet&quot;</span> <span class='nt'>/&gt;</span>

  <span class='c'>&lt;!-- the style --&gt;</span>
  <span class='nt'>&lt;style&gt;</span>
  <span class='nt'>div</span><span class='nf'>#barchart</span> <span class='p'>{}</span>
  <span class='c'>/* ... some CSS ... */</span>
  <span class='nt'>&lt;/style&gt;</span>
<span class='nt'>&lt;/head&gt;</span>
<span class='nt'>&lt;body&gt;</span>

<span class='nt'>&lt;div</span> <span class='na'>id=</span><span class='s'>&quot;content&quot;</span><span class='nt'>&gt;</span>
  <span class='nt'>&lt;div</span> <span class='na'>id=</span><span class='s'>&quot;map&quot;</span><span class='nt'>&gt;&lt;/div&gt;</span>
  <span class='nt'>&lt;div</span> <span class='na'>id=</span><span class='s'>&quot;barchart&quot;</span><span class='nt'>&gt;</span>
    <span class='nt'>&lt;div</span> <span class='na'>id=</span><span class='s'>&quot;tip&quot;</span> <span class='na'>style=</span><span class='s'>&#39;display:none&#39;</span><span class='nt'>&gt;&lt;/div&gt;</span>
  <span class='nt'>&lt;/div&gt;</span>
<span class='nt'>&lt;/div&gt;</span>

<span class='c'>&lt;!-- load the data --&gt;</span>
<span class='nt'>&lt;script </span><span class='na'>src=</span><span class='s'>&quot;weibo.js&quot;</span><span class='nt'>&gt;&lt;/script&gt;</span>

<span class='c'>&lt;!-- load the d3.js library --&gt;</span>
<span class='nt'>&lt;script </span><span class='na'>src=</span><span class='s'>&quot;http://d3js.org/d3.v3.min.js&quot;</span><span class='nt'>&gt;&lt;/script&gt;</span>

<span class='c'>&lt;!-- the script --&gt;</span>
  <span class='nt'>&lt;script&gt;</span>
<span class='cm'>/* ... some JavaScript ... */</span>
  <span class='nt'>&lt;/script&gt;</span>
<span class='nt'>&lt;/body&gt;</span>
<span class='nt'>&lt;/html&gt;</span>
</code></pre></div>
<h2 id="the_bar_chart_explained">The bar chart explained</h2>

<p>The <a href="http://d3js.org">D3</a> SVG (<a href="http://www.w3.org/Graphics/SVG/">Scalable Vector Graphics</a>) bar chart is made of a <em>g</em> element for the y axis, a <em>g</em> element for the bars and a <em>text</em> element for the title. The <em>g</em> element of the bars contains itself 24 <em>g</em> elements. Each of them contains a <em>rect</em> for the actual bar and a <em>text</em> for the hour in the x axis.</p>
<svg height='190' width='400'>
	<g height='100' transform='translate(1,1)' width='50'>
		<rect height='106' style='fill:white; stroke:#3182bd; stroke-width:1px;' width='50' x='0' y='0' />
		<text style='fill:#3182bd;' x='7' y='50'>y axis</text>
	</g>
	<g height='141' transform='translate(54,1)' width='345'>
		<rect height='141' style='fill:white; stroke:#3182bd; stroke-width:1px;' width='345' x='0' y='0' />
		<g height='135' transform='translate(3,3)' width='46'>
			<rect height='135' style='fill:white; stroke:#3182bd; stroke-width:1px;' width='46' x='0' y='0' />
			<rect height='99' style='fill:white; stroke:red; stroke-width:1px;' width='40' x='3' y='3' />
			<text style='fill:red;' x='11' y='50'>bar</text>
			<rect height='27' style='fill:white; stroke:orange; stroke-width:1px;' width='40' x='3' y='105' />
			<text style='fill:orange;' x='6' y='123'>x axis</text>
		</g>
		<text style='fill:#ccc;' x='60' y='80'>x 24</text>
	</g>
	<g height='45' transform='translate(54,145)' width='345'>
		<rect height='40' style='fill:white; stroke:orange; stroke-width:1px;' width='345' x='0' y='0' />
		<text style='fill:orange;' x='150' y='20'>title</text>
	</g>
</svg>
<p>Let’s focus now on the JavaScript part.</p>

<p>First, we define some constants for the colors and sizes.</p>
<div class='highlight'><pre><code class='javascript'><span class='kd'>var</span> <span class='nx'>barColorOut</span> <span class='o'>=</span> <span class='s1'>&#39;#4c5b68&#39;</span><span class='p'>,</span>
  <span class='nx'>barColorOn</span> <span class='o'>=</span> <span class='s1'>&#39;#a7b7b6&#39;</span><span class='p'>,</span>
  <span class='nx'>legendColor</span> <span class='o'>=</span> <span class='s1'>&#39;#404040&#39;</span><span class='p'>;</span>

<span class='kd'>var</span> <span class='nx'>barWidth</span> <span class='o'>=</span> <span class='mi'>20</span><span class='p'>,</span>
  <span class='nx'>barsWidth</span> <span class='o'>=</span> <span class='mi'>24</span> <span class='o'>*</span> <span class='nx'>barWidth</span><span class='p'>,</span>
  <span class='nx'>yAxisWidth</span> <span class='o'>=</span> <span class='mi'>55</span><span class='p'>,</span>
  <span class='nx'>chartWidth</span> <span class='o'>=</span> <span class='nx'>yAxisWidth</span> <span class='o'>+</span> <span class='nx'>barsWidth</span><span class='p'>;</span>
  
<span class='kd'>var</span> <span class='nx'>barMaxHeight</span> <span class='o'>=</span> <span class='mi'>100</span><span class='p'>,</span>
  <span class='nx'>xAxisHeight</span> <span class='o'>=</span> <span class='mi'>15</span><span class='p'>,</span>
  <span class='nx'>chartTitleHeight</span> <span class='o'>=</span> <span class='mi'>45</span><span class='p'>,</span>
  <span class='nx'>chartHeight</span> <span class='o'>=</span> <span class='nx'>barMaxHeight</span> <span class='o'>+</span> <span class='nx'>xAxisHeight</span> <span class='o'>+</span> <span class='nx'>chartTitleHeight</span><span class='p'>;</span>
</code></pre></div>
<p>Before we create the chart, we prepare the data we are going to use. We need to count the total number of messages for each hour of the day. To do so, we make a loop over the <code class='highlight'><span class='nx'>weibo</span></code> variable to sum the number of every location for each hour. The results are stored in an array called <code class='highlight'><span class='nx'>nbMsgByHour</span></code>.</p>
<div class='highlight'><pre><code class='javascript'><span class='kd'>var</span> <span class='nx'>nbMsgsByHour</span> <span class='o'>=</span> <span class='p'>[</span><span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>];</span>
<span class='k'>for</span> <span class='p'>(</span><span class='kd'>var</span> <span class='nx'>coord</span> <span class='k'>in</span> <span class='nx'>weibo</span><span class='p'>)</span> <span class='p'>{</span>
  <span class='k'>for</span> <span class='p'>(</span><span class='kd'>var</span> <span class='nx'>j</span><span class='o'>=</span><span class='mi'>0</span><span class='p'>;</span> <span class='nx'>j</span> <span class='o'>&lt;</span> <span class='mi'>24</span><span class='p'>;</span> <span class='nx'>j</span><span class='o'>++</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='nx'>nbMsgsByHour</span><span class='p'>[</span><span class='nx'>j</span><span class='p'>]</span> <span class='o'>+=</span> <span class='nx'>weibo</span><span class='p'>[</span><span class='nx'>coord</span><span class='p'>][</span><span class='nx'>j</span><span class='p'>];</span>
  <span class='p'>}</span>
<span class='p'>}</span>
</code></pre></div>
<p>We find the maximum value so that we can define the function to scale the values to the appropriate bar heights.</p>
<div class='highlight'><pre><code class='javascript'><span class='kd'>var</span> <span class='nx'>countMax</span> <span class='o'>=</span> <span class='nx'>nbMsgsByHour</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>];</span>
<span class='k'>for</span> <span class='p'>(</span><span class='kd'>var</span> <span class='nx'>i</span><span class='o'>=</span><span class='mi'>1</span><span class='p'>;</span> <span class='nx'>i</span> <span class='o'>&lt;</span> <span class='mi'>24</span><span class='p'>;</span> <span class='nx'>i</span><span class='o'>++</span><span class='p'>)</span> <span class='p'>{</span>
  <span class='k'>if</span> <span class='p'>(</span><span class='nx'>nbMsgsByHour</span><span class='p'>[</span><span class='nx'>i</span><span class='p'>]</span> <span class='o'>&gt;</span> <span class='nx'>countMax</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='nx'>countMax</span> <span class='o'>=</span> <span class='nx'>nbMsgsByHour</span><span class='p'>[</span><span class='nx'>i</span><span class='p'>];</span>
  <span class='p'>}</span>
<span class='p'>}</span>
<span class='kd'>var</span> <span class='nx'>barHeight</span> <span class='o'>=</span> <span class='nx'>d3</span><span class='p'>.</span><span class='nx'>scale</span><span class='p'>.</span><span class='nx'>linear</span><span class='p'>()</span>
  <span class='p'>.</span><span class='nx'>domain</span><span class='p'>([</span><span class='mi'>0</span><span class='p'>,</span> <span class='nx'>countMax</span><span class='p'>])</span>
  <span class='p'>.</span><span class='nx'>range</span><span class='p'>([</span><span class='mi'>0</span><span class='p'>,</span> <span class='nx'>barMaxHeight</span><span class='p'>]);</span>
</code></pre></div>
<p>Now we can create the bar chart. The following block of code selects the <code class='highlight'><span class='nt'>div</span><span class='nf'>#barchart</span></code> on the page and appends an svg object to it of the size that we have set up.</p>
<div class='highlight'><pre><code class='javascript'><span class='kd'>var</span> <span class='nx'>chart</span> <span class='o'>=</span> <span class='nx'>d3</span><span class='p'>.</span><span class='nx'>select</span><span class='p'>(</span><span class='s1'>&#39;div#barchart&#39;</span><span class='p'>).</span><span class='nx'>append</span><span class='p'>(</span><span class='s1'>&#39;svg&#39;</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;width&#39;</span><span class='p'>,</span> <span class='nx'>chartWidth</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;height&#39;</span><span class='p'>,</span> <span class='nx'>chartHeight</span><span class='p'>);</span>
</code></pre></div>
<p>First, we create the y Axis. It uses almost the same scale function as the bars except that in the axis the values are oriented from top to bottom by default so we reverse the order for range. This axis is going to be oriented to the left with 5 ticks on it. As already told, the y axis is appended to the chart within a <em>g</em> element.</p>
<div class='highlight'><pre><code class='javascript'><span class='kd'>var</span> <span class='nx'>yAxis</span> <span class='o'>=</span> <span class='nx'>d3</span><span class='p'>.</span><span class='nx'>svg</span><span class='p'>.</span><span class='nx'>axis</span><span class='p'>()</span>
  <span class='p'>.</span><span class='nx'>scale</span><span class='p'>(</span><span class='nx'>d3</span><span class='p'>.</span><span class='nx'>scale</span><span class='p'>.</span><span class='nx'>linear</span><span class='p'>()</span>
    <span class='p'>.</span><span class='nx'>domain</span><span class='p'>([</span><span class='mi'>0</span><span class='p'>,</span> <span class='nx'>countMax</span><span class='p'>])</span>
    <span class='p'>.</span><span class='nx'>range</span><span class='p'>([</span><span class='nx'>barMaxHeight</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>]))</span>
  <span class='p'>.</span><span class='nx'>orient</span><span class='p'>(</span><span class='s1'>&#39;left&#39;</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>ticks</span><span class='p'>(</span><span class='mi'>5</span><span class='p'>);</span>

<span class='nx'>chart</span><span class='p'>.</span><span class='nx'>append</span><span class='p'>(</span><span class='s1'>&#39;g&#39;</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;class&#39;</span><span class='p'>,</span> <span class='s1'>&#39;y axis&#39;</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;width&#39;</span><span class='p'>,</span> <span class='nx'>yAxisWidth</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;transform&#39;</span><span class='p'>,</span> <span class='s2'>&quot;translate(45, 0)&quot;</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>call</span><span class='p'>(</span><span class='nx'>yAxis</span><span class='p'>);</span>
</code></pre></div>
<p>For the bars, we append a new <em>g</em> element to the chart on the right of the y axis.</p>
<div class='highlight'><pre><code class='javascript'><span class='kd'>var</span> <span class='nx'>bars</span> <span class='o'>=</span> <span class='nx'>chart</span><span class='p'>.</span><span class='nx'>append</span><span class='p'>(</span><span class='s1'>&#39;g&#39;</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;width&#39;</span><span class='p'>,</span> <span class='nx'>barsWidth</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;transform&#39;</span><span class='p'>,</span> <span class='s2'>&quot;translate(&quot;</span> <span class='o'>+</span> <span class='nx'>yAxisWidth</span> <span class='o'>+</span> <span class='s2'>&quot;, 0)&quot;</span><span class='p'>);</span>
</code></pre></div>
<p>And we add the bars to this element:</p>
<div class='highlight'><pre><code class='javascript'><span class='kd'>var</span> <span class='nx'>gEnter</span> <span class='o'>=</span> <span class='nx'>bars</span><span class='p'>.</span><span class='nx'>selectAll</span><span class='p'>(</span><span class='s1'>&#39;g&#39;</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>data</span><span class='p'>(</span><span class='nx'>nbMsgsByHour</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>enter</span><span class='p'>().</span><span class='nx'>append</span><span class='p'>(</span><span class='s1'>&#39;g&#39;</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;transform&#39;</span><span class='p'>,</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>,</span><span class='nx'>i</span><span class='p'>){</span> <span class='k'>return</span> <span class='s2'>&quot;translate(&quot;</span> <span class='o'>+</span> <span class='nx'>i</span> <span class='o'>*</span> <span class='nx'>barWidth</span> <span class='o'>+</span> <span class='s2'>&quot;, 0)&quot;</span><span class='p'>;</span> <span class='p'>})</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;width&#39;</span><span class='p'>,</span> <span class='nx'>barWidth</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;height&#39;</span><span class='p'>,</span> <span class='nx'>barMaxHeight</span> <span class='o'>+</span> <span class='nx'>xAxisHeight</span><span class='p'>);</span>
</code></pre></div>
<p>This block of code creates the bars and associates each of them with a data set ( <code class='highlight'><span class='p'>.</span><span class='nx'>data</span><span class='p'>(</span><span class='nx'>nbMsgsByHour</span><span class='p'>)</span></code> ). For each value in <code class='highlight'><span class='nx'>nbMsgsByHour</span></code>, a <em>g</em> element is to be created. Note that the position of each <em>g</em> is determined by a function so that its x position can depend on the index of the value in <code class='highlight'><span class='nx'>nbMsgsByHour</span></code>. The <code class='highlight'><span class='nx'>i</span></code> parameter of this function stands for the index in <code class='highlight'><span class='nx'>nbMsgsByHour</span></code> and the <code class='highlight'><span class='nx'>d</span></code> parameter stands for the value (that is to say <code class='highlight'><span class='nx'>nbMsgsByHour</span><span class='p'>[</span><span class='nx'>i</span><span class='p'>]</span></code>).</p>

<p>As previously said, each of these 24 <em>g</em> element in turn contains a <em>rect</em> and a <em>text</em>. So we add a <em>rect</em> and a <em>text</em> to these <em>g</em>.</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>gEnter</span><span class='p'>.</span><span class='nx'>append</span><span class='p'>(</span><span class='s1'>&#39;rect&#39;</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;x&#39;</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;y&#39;</span><span class='p'>,</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>){</span> <span class='k'>return</span> <span class='nx'>barMaxHeight</span> <span class='o'>-</span> <span class='nx'>barHeight</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>);</span> <span class='p'>})</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;width&#39;</span><span class='p'>,</span> <span class='nx'>barWidth</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;height&#39;</span><span class='p'>,</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>){</span> <span class='k'>return</span> <span class='nx'>barHeight</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>);</span> <span class='p'>})</span>
  <span class='p'>.</span><span class='nx'>style</span><span class='p'>(</span><span class='s1'>&#39;fill&#39;</span><span class='p'>,</span> <span class='nx'>barColorOut</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>style</span><span class='p'>(</span><span class='s1'>&#39;stroke&#39;</span><span class='p'>,</span> <span class='s1'>&#39;white&#39;</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>style</span><span class='p'>(</span><span class='s1'>&#39;stroke-width&#39;</span><span class='p'>,</span> <span class='mi'>1</span><span class='p'>);</span>

<span class='nx'>gEnter</span><span class='p'>.</span><span class='nx'>append</span><span class='p'>(</span><span class='s1'>&#39;text&#39;</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;x&#39;</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;y&#39;</span><span class='p'>,</span> <span class='nx'>barMaxHeight</span> <span class='o'>+</span> <span class='nx'>xAxisHeight</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;width&#39;</span><span class='p'>,</span> <span class='nx'>barWidth</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;height&#39;</span><span class='p'>,</span> <span class='nx'>xAxisHeight</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>style</span><span class='p'>(</span><span class='s1'>&#39;fill&#39;</span><span class='p'>,</span> <span class='nx'>legendColor</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>style</span><span class='p'>(</span><span class='s1'>&#39;font-size&#39;</span><span class='p'>,</span> <span class='s1'>&#39;10px&#39;</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>text</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>,</span><span class='nx'>i</span><span class='p'>){</span> <span class='k'>return</span> <span class='nx'>i</span><span class='p'>;</span> <span class='p'>});</span>
</code></pre></div>
<p>Note that the height (and the position) of the bar relies on the call of our <code class='highlight'><span class='nx'>barHeight</span></code> function with each value. The hour in the x axis is simply the index of the value.</p>

<p>Lastly we have to add a title to our chart:</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>chart</span><span class='p'>.</span><span class='nx'>append</span><span class='p'>(</span><span class='s1'>&#39;text&#39;</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;x&#39;</span><span class='p'>,</span> <span class='nx'>yAxisWidth</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;y&#39;</span><span class='p'>,</span> <span class='nx'>chartHeight</span> <span class='o'>-</span> <span class='mi'>13</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;width&#39;</span><span class='p'>,</span> <span class='nx'>barsWidth</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>style</span><span class='p'>(</span><span class='s1'>&#39;fill&#39;</span><span class='p'>,</span> <span class='nx'>legendColor</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>style</span><span class='p'>(</span><span class='s1'>&#39;font-size&#39;</span><span class='p'>,</span> <span class='s1'>&#39;13px&#39;</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>style</span><span class='p'>(</span><span class='s1'>&#39;font-weight&#39;</span><span class='p'>,</span> <span class='s1'>&#39;bold&#39;</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>style</span><span class='p'>(</span><span class='s1'>&#39;text-align&#39;</span><span class='p'>,</span> <span class='s1'>&#39;center&#39;</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>text</span><span class='p'>(</span><span class='s2'>&quot;Number of messages by hour of the day&quot;</span><span class='p'>);</span>
</code></pre></div>
<p>We are also want a tooltip to show up when one mouses over a bar to display the actual value. To do so, we are going to use the <code class='highlight'><span class='nt'>div</span><span class='nf'>#tip</span></code> of our HTML code and add two functions to show and hide the tooltip.</p>
<div class='highlight'><pre><code class='javascript'><span class='kd'>function</span> <span class='nx'>showTip</span><span class='p'>(</span><span class='nx'>count</span><span class='p'>,</span> <span class='nx'>top</span><span class='p'>,</span> <span class='nx'>left</span><span class='p'>)</span> <span class='p'>{</span>
  <span class='nx'>d3</span><span class='p'>.</span><span class='nx'>select</span><span class='p'>(</span><span class='s1'>&#39;#tip&#39;</span><span class='p'>)</span>
    <span class='p'>.</span><span class='nx'>text</span><span class='p'>(</span><span class='nx'>count</span><span class='p'>)</span>
    <span class='p'>.</span><span class='nx'>style</span><span class='p'>(</span><span class='s1'>&#39;top&#39;</span><span class='p'>,</span> <span class='nx'>top</span> <span class='o'>+</span> <span class='s2'>&quot;px&quot;</span><span class='p'>)</span>
    <span class='p'>.</span><span class='nx'>style</span><span class='p'>(</span><span class='s1'>&#39;left&#39;</span><span class='p'>,</span> <span class='nx'>left</span> <span class='o'>+</span> <span class='s2'>&quot;px&quot;</span><span class='p'>)</span>
    <span class='p'>.</span><span class='nx'>style</span><span class='p'>(</span><span class='s1'>&#39;display&#39;</span><span class='p'>,</span> <span class='s1'>&#39;block&#39;</span><span class='p'>);</span>
<span class='p'>}</span>

<span class='kd'>function</span> <span class='nx'>hideTip</span><span class='p'>()</span> <span class='p'>{</span>
  <span class='nx'>d3</span><span class='p'>.</span><span class='nx'>select</span><span class='p'>(</span><span class='s1'>&#39;#tip&#39;</span><span class='p'>)</span>
    <span class='p'>.</span><span class='nx'>text</span><span class='p'>(</span><span class='s2'>&quot;&quot;</span><span class='p'>)</span>
    <span class='p'>.</span><span class='nx'>style</span><span class='p'>(</span><span class='s1'>&#39;display&#39;</span><span class='p'>,</span> <span class='s1'>&#39;none&#39;</span><span class='p'>);</span>
<span class='p'>}</span>
</code></pre></div>
<p>We change the code for the bar <em>rect</em> to handle the <em>mouseover</em> and <em>mouseout</em> events. To help the user know which bar is emphasized, we also change the color of the bar.</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>gEnter</span><span class='p'>.</span><span class='nx'>append</span><span class='p'>(</span><span class='s1'>&#39;rect&#39;</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;x&#39;</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;y&#39;</span><span class='p'>,</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>){</span> <span class='k'>return</span> <span class='nx'>barMaxHeight</span> <span class='o'>-</span> <span class='nx'>barHeight</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>);</span> <span class='p'>})</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;width&#39;</span><span class='p'>,</span> <span class='nx'>barWidth</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;height&#39;</span><span class='p'>,</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>){</span> <span class='k'>return</span> <span class='nx'>barHeight</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>);</span> <span class='p'>})</span>
  <span class='p'>.</span><span class='nx'>style</span><span class='p'>(</span><span class='s1'>&#39;fill&#39;</span><span class='p'>,</span> <span class='nx'>barColorOut</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>style</span><span class='p'>(</span><span class='s1'>&#39;stroke&#39;</span><span class='p'>,</span> <span class='s1'>&#39;white&#39;</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>style</span><span class='p'>(</span><span class='s1'>&#39;stroke-width&#39;</span><span class='p'>,</span> <span class='mi'>1</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>on</span><span class='p'>(</span><span class='s1'>&#39;mouseover&#39;</span><span class='p'>,</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>,</span><span class='nx'>i</span><span class='p'>)</span> <span class='p'>{</span>	<span class='c1'>// &lt;&lt;-</span>
    <span class='nx'>d3</span><span class='p'>.</span><span class='nx'>select</span><span class='p'>(</span><span class='k'>this</span><span class='p'>).</span><span class='nx'>transition</span><span class='p'>()</span>
      <span class='p'>.</span><span class='nx'>duration</span><span class='p'>(</span><span class='mi'>100</span><span class='p'>)</span>
      <span class='p'>.</span><span class='nx'>style</span><span class='p'>(</span><span class='s1'>&#39;fill&#39;</span><span class='p'>,</span> <span class='nx'>barColorOn</span><span class='p'>);</span>
    <span class='nx'>showTip</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>,</span> <span class='p'>(</span><span class='nx'>barMaxHeight</span> <span class='o'>-</span> <span class='nx'>barHeight</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>)</span> <span class='o'>-</span> <span class='mi'>30</span><span class='p'>),</span> <span class='p'>(</span><span class='nx'>yAxisWidth</span> <span class='o'>+</span> <span class='nx'>i</span> <span class='o'>*</span> <span class='nx'>barWidth</span> <span class='o'>-</span> <span class='mi'>13</span><span class='p'>));</span>
  <span class='p'>})</span>
  <span class='p'>.</span><span class='nx'>on</span><span class='p'>(</span><span class='s1'>&#39;mouseout&#39;</span><span class='p'>,</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>,</span><span class='nx'>i</span><span class='p'>){</span>	<span class='c1'>// &lt;&lt;-</span>
    <span class='nx'>d3</span><span class='p'>.</span><span class='nx'>select</span><span class='p'>(</span><span class='k'>this</span><span class='p'>).</span><span class='nx'>transition</span><span class='p'>()</span>
      <span class='p'>.</span><span class='nx'>duration</span><span class='p'>(</span><span class='mi'>500</span><span class='p'>)</span>
      <span class='p'>.</span><span class='nx'>style</span><span class='p'>(</span><span class='s1'>&#39;fill&#39;</span><span class='p'>,</span> <span class='nx'>barColorOut</span><span class='p'>);</span>
    <span class='nx'>hideTip</span><span class='p'>();</span>
  <span class='p'>});</span>
</code></pre></div>
<p>And check the resulting bar chart in <a href="/studies/">Weibo spatial and temporal data</a>!</p>

<h2 id="the_map_explained">The map explained</h2>

<p>First, we need to initialize the <a href="http://mapbox.com">Mapbox</a> map into the <code class='highlight'><span class='nt'>div</span><span class='nf'>#map</span></code> element (change <code class='highlight'><span class='s1'>&#39;USER.MAP&#39;</span></code> to your own map reference). The map is centered on Shanghai coordinates with a zoom of 11.</p>
<div class='highlight'><pre><code class='javascript'><span class='kd'>var</span> <span class='nx'>map</span> <span class='o'>=</span> <span class='nx'>L</span><span class='p'>.</span><span class='nx'>mapbox</span><span class='p'>.</span><span class='nx'>map</span><span class='p'>(</span><span class='s1'>&#39;map&#39;</span><span class='p'>,</span> <span class='s1'>&#39;USER.MAP&#39;</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>setView</span><span class='p'>([</span><span class='mf'>31.2542</span><span class='p'>,</span> <span class='mf'>121.4904</span><span class='p'>],</span> <span class='mi'>11</span><span class='p'>);</span>
</code></pre></div>
<p>Now that we have a map on the web page, let’s customize it with some data. Just as for the bar chart, we need to prepare the data. The next block of code stores into a <code class='highlight'><span class='nx'>circles</span></code> array the list of circles to be displayed on the map for each hour. And at the end ( <code class='highlight'><span class='nx'>circles</span><span class='p'>[</span><span class='mi'>24</span><span class='p'>]</span></code> ), another list of circles represents the total number of messages by location regardless of the time of the day. To get these numbers, we simply sum the numbers of messages of every hours for each location.</p>

<p>Each circle is a <a href="https://www.mapbox.com/mapbox.js/api/v1.6.3/l-circle/">L.Circle</a> object centered on one of our 85 locations with a radius of 2000 m. The color used to fill each circle depends on the number of messages. Therefore, we use a function to determine the color depending of the given value. Actually, we are going to make two functions to implement different scales for the number of messages by hour or in total: getColor will serve for the hourly values and getGlobalColor for the total values.</p>
<div class='highlight'><pre><code class='javascript'><span class='kd'>var</span> <span class='nx'>colors</span> <span class='o'>=</span> <span class='p'>[</span><span class='s1'>&#39;#f0f9e9&#39;</span><span class='p'>,</span> <span class='s1'>&#39;#ccecc7&#39;</span><span class='p'>,</span> <span class='s1'>&#39;#a8deb7&#39;</span><span class='p'>,</span> <span class='s1'>&#39;#7ecdc4&#39;</span><span class='p'>,</span> <span class='s1'>&#39;#4aa2c8&#39;</span><span class='p'>,</span> <span class='s1'>&#39;#1d67a9&#39;</span><span class='p'>];</span>

<span class='kd'>function</span> <span class='nx'>getGlobalColor</span><span class='p'>(</span><span class='nx'>value</span><span class='p'>)</span> <span class='p'>{</span>
  <span class='k'>if</span> <span class='p'>(</span><span class='nx'>value</span> <span class='o'>&lt;=</span> <span class='mi'>800</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='k'>return</span> <span class='nx'>colors</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>];</span>
  <span class='p'>}</span> <span class='k'>else</span> <span class='k'>if</span> <span class='p'>(</span><span class='nx'>value</span> <span class='o'>&lt;=</span> <span class='mi'>1600</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='k'>return</span> <span class='nx'>colors</span><span class='p'>[</span><span class='mi'>1</span><span class='p'>];</span>
  <span class='p'>}</span> <span class='k'>else</span> <span class='k'>if</span> <span class='p'>(</span><span class='nx'>value</span> <span class='o'>&lt;=</span> <span class='mi'>4500</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='k'>return</span> <span class='nx'>colors</span><span class='p'>[</span><span class='mi'>2</span><span class='p'>];</span>
  <span class='p'>}</span> <span class='k'>else</span> <span class='k'>if</span> <span class='p'>(</span><span class='nx'>value</span> <span class='o'>&lt;=</span> <span class='mi'>6400</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='k'>return</span> <span class='nx'>colors</span><span class='p'>[</span><span class='mi'>3</span><span class='p'>];</span>
  <span class='p'>}</span> <span class='k'>else</span> <span class='k'>if</span> <span class='p'>(</span><span class='nx'>value</span> <span class='o'>&lt;=</span> <span class='mi'>9600</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='k'>return</span> <span class='nx'>colors</span><span class='p'>[</span><span class='mi'>4</span><span class='p'>];</span>
  <span class='p'>}</span>
  <span class='k'>return</span> <span class='nx'>colors</span><span class='p'>[</span><span class='mi'>5</span><span class='p'>];</span>
<span class='p'>}</span>

<span class='kd'>function</span> <span class='nx'>getColor</span><span class='p'>(</span><span class='nx'>value</span><span class='p'>)</span> <span class='p'>{</span>
  <span class='k'>if</span> <span class='p'>(</span><span class='nx'>value</span> <span class='o'>&lt;=</span> <span class='mi'>70</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='k'>return</span> <span class='nx'>colors</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>];</span>
  <span class='p'>}</span> <span class='k'>else</span> <span class='k'>if</span> <span class='p'>(</span><span class='nx'>value</span> <span class='o'>&lt;=</span> <span class='mi'>140</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='k'>return</span> <span class='nx'>colors</span><span class='p'>[</span><span class='mi'>1</span><span class='p'>];</span>
  <span class='p'>}</span> <span class='k'>else</span> <span class='k'>if</span> <span class='p'>(</span><span class='nx'>value</span> <span class='o'>&lt;=</span> <span class='mi'>250</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='k'>return</span> <span class='nx'>colors</span><span class='p'>[</span><span class='mi'>2</span><span class='p'>];</span>
  <span class='p'>}</span> <span class='k'>else</span> <span class='k'>if</span> <span class='p'>(</span><span class='nx'>value</span> <span class='o'>&lt;=</span> <span class='mi'>400</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='k'>return</span> <span class='nx'>colors</span><span class='p'>[</span><span class='mi'>3</span><span class='p'>];</span>
  <span class='p'>}</span> <span class='k'>else</span> <span class='k'>if</span> <span class='p'>(</span><span class='nx'>value</span> <span class='o'>&lt;=</span> <span class='mi'>600</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='k'>return</span> <span class='nx'>colors</span><span class='p'>[</span><span class='mi'>4</span><span class='p'>];</span>
  <span class='p'>}</span>
  <span class='k'>return</span> <span class='nx'>colors</span><span class='p'>[</span><span class='mi'>5</span><span class='p'>];</span>
<span class='p'>}</span>

<span class='kd'>var</span> <span class='nx'>circles</span> <span class='o'>=</span> <span class='p'>[[],</span> <span class='p'>[],</span> <span class='p'>[],</span> <span class='p'>[],</span> <span class='p'>[],</span> <span class='p'>[],</span> <span class='p'>[],</span> <span class='p'>[],</span> <span class='p'>[],</span> <span class='p'>[],</span>
 <span class='p'>[],</span> <span class='p'>[],</span> <span class='p'>[],</span> <span class='p'>[],</span> <span class='p'>[],</span> <span class='p'>[],</span> <span class='p'>[],</span> <span class='p'>[],</span> <span class='p'>[],</span> <span class='p'>[],</span>
 <span class='p'>[],</span> <span class='p'>[],</span> <span class='p'>[],</span> <span class='p'>[],</span> <span class='p'>[]];</span>

<span class='k'>for</span> <span class='p'>(</span><span class='kd'>var</span> <span class='nx'>coord</span> <span class='k'>in</span> <span class='nx'>weibo</span><span class='p'>)</span> <span class='p'>{</span>
  <span class='nx'>latlng</span> <span class='o'>=</span> <span class='nx'>coord</span><span class='p'>.</span><span class='nx'>split</span><span class='p'>(</span><span class='s2'>&quot;, &quot;</span><span class='p'>);</span>
  <span class='nx'>latlng</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>]</span> <span class='o'>=</span> <span class='nb'>parseFloat</span><span class='p'>(</span><span class='nx'>latlng</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>]);</span>
  <span class='nx'>latlng</span><span class='p'>[</span><span class='mi'>1</span><span class='p'>]</span> <span class='o'>=</span> <span class='nb'>parseFloat</span><span class='p'>(</span><span class='nx'>latlng</span><span class='p'>[</span><span class='mi'>1</span><span class='p'>]);</span>
  <span class='kd'>var</span> <span class='nx'>count</span> <span class='o'>=</span> <span class='mi'>0</span><span class='p'>;</span>
  <span class='k'>for</span> <span class='p'>(</span><span class='kd'>var</span> <span class='nx'>i</span><span class='o'>=</span><span class='mi'>0</span><span class='p'>;</span> <span class='nx'>i</span> <span class='o'>&lt;</span> <span class='mi'>24</span><span class='p'>;</span> <span class='nx'>i</span><span class='o'>++</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='nx'>count</span> <span class='o'>+=</span> <span class='nx'>weibo</span><span class='p'>[</span><span class='nx'>coord</span><span class='p'>][</span><span class='nx'>i</span><span class='p'>];</span>
    <span class='kd'>var</span> <span class='nx'>circle_options</span> <span class='o'>=</span> <span class='p'>{</span>
      <span class='nx'>stroke</span><span class='o'>:</span> <span class='kc'>false</span><span class='p'>,</span>
      <span class='nx'>fillColor</span><span class='o'>:</span> <span class='nx'>getColor</span><span class='p'>(</span><span class='nx'>weibo</span><span class='p'>[</span><span class='nx'>coord</span><span class='p'>][</span><span class='nx'>i</span><span class='p'>]),</span>
      <span class='nx'>fillOpacity</span><span class='o'>:</span> <span class='mf'>0.5</span>
    <span class='p'>};</span>
    <span class='nx'>circles</span><span class='p'>[</span><span class='nx'>i</span><span class='p'>].</span><span class='nx'>push</span><span class='p'>(</span><span class='nx'>L</span><span class='p'>.</span><span class='nx'>circle</span><span class='p'>([</span><span class='nx'>latlng</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>],</span> <span class='nx'>latlng</span><span class='p'>[</span><span class='mi'>1</span><span class='p'>]],</span> <span class='mi'>2000</span><span class='p'>,</span> <span class='nx'>circle_options</span><span class='p'>));</span>
  <span class='p'>}</span>
  <span class='kd'>var</span> <span class='nx'>circle_options</span> <span class='o'>=</span> <span class='p'>{</span>
    <span class='nx'>stroke</span><span class='o'>:</span> <span class='kc'>false</span><span class='p'>,</span>
    <span class='nx'>fillColor</span><span class='o'>:</span> <span class='nx'>getGlobalColor</span><span class='p'>(</span><span class='nx'>count</span><span class='p'>),</span>
    <span class='nx'>fillOpacity</span><span class='o'>:</span> <span class='mf'>0.6</span>
  <span class='p'>};</span>
  <span class='nx'>circles</span><span class='p'>[</span><span class='mi'>24</span><span class='p'>].</span><span class='nx'>push</span><span class='p'>(</span><span class='nx'>L</span><span class='p'>.</span><span class='nx'>circle</span><span class='p'>([</span><span class='nx'>latlng</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>],</span> <span class='nx'>latlng</span><span class='p'>[</span><span class='mi'>1</span><span class='p'>]],</span> <span class='mi'>2000</span><span class='p'>,</span> <span class='nx'>circle_options</span><span class='p'>));</span>
<span class='p'>}</span>
</code></pre></div>
<p>Then, we need to be able to add (and remove) circles to (from) the map. The purpose of the following functions is to add or remove all the circles for a given hour, that is to say the list of circles at <code class='highlight'><span class='nx'>circles</span><span class='p'>[</span><span class='nx'>i</span><span class='p'>]</span></code>.</p>
<div class='highlight'><pre><code class='javascript'><span class='kd'>function</span> <span class='nx'>addLayer</span><span class='p'>(</span><span class='nx'>i</span><span class='p'>)</span> <span class='p'>{</span>
  <span class='k'>for</span> <span class='p'>(</span><span class='kd'>var</span> <span class='nx'>j</span><span class='o'>=</span><span class='mi'>0</span><span class='p'>;</span> <span class='nx'>j</span> <span class='o'>&lt;</span> <span class='nx'>circles</span><span class='p'>[</span><span class='nx'>i</span><span class='p'>].</span><span class='nx'>length</span><span class='p'>;</span> <span class='nx'>j</span><span class='o'>++</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='nx'>circles</span><span class='p'>[</span><span class='nx'>i</span><span class='p'>][</span><span class='nx'>j</span><span class='p'>].</span><span class='nx'>addTo</span><span class='p'>(</span><span class='nx'>map</span><span class='p'>);</span>
  <span class='p'>}</span>
  <span class='nx'>currentLayer</span> <span class='o'>=</span> <span class='nx'>i</span><span class='p'>;</span>
<span class='p'>}</span>

<span class='kd'>function</span> <span class='nx'>removeLayer</span><span class='p'>(</span><span class='nx'>i</span><span class='p'>)</span> <span class='p'>{</span>
  <span class='k'>for</span> <span class='p'>(</span><span class='kd'>var</span> <span class='nx'>j</span><span class='o'>=</span><span class='mi'>0</span><span class='p'>;</span> <span class='nx'>j</span> <span class='o'>&lt;</span> <span class='nx'>circles</span><span class='p'>[</span><span class='nx'>i</span><span class='p'>].</span><span class='nx'>length</span><span class='p'>;</span> <span class='nx'>j</span><span class='o'>++</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='nx'>map</span><span class='p'>.</span><span class='nx'>removeLayer</span><span class='p'>(</span><span class='nx'>circles</span><span class='p'>[</span><span class='nx'>i</span><span class='p'>][</span><span class='nx'>j</span><span class='p'>]);</span>
  <span class='p'>}</span>
<span class='p'>}</span>
</code></pre></div>
<p>By default, we want the map to show the total number of messages for each location.</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>addLayer</span><span class='p'>(</span><span class='mi'>24</span><span class='p'>);</span>
<span class='kd'>var</span> <span class='nx'>currentLayer</span> <span class='o'>=</span> <span class='mi'>0</span><span class='p'>;</span>
</code></pre></div>
<p>The variable <code class='highlight'><span class='nx'>currentLayer</span></code> is going to help us keep track of the index of the list of circles currently displayed.</p>

<p>Now, we simply have to to modify the handlers of the <em>mouseover</em> and <em>mouseout</em> events in the bar chart to display the proper list of circles. When the mouse passes over a bar we want to remove the list of circles currently displayed ( <code class='highlight'><span class='nx'>removeLayer</span><span class='p'>(</span><span class='nx'>currentLayer</span><span class='p'>)</span></code> ) and to show the list of circles corresponding to the selected hour ( <code class='highlight'><span class='nx'>addLayer</span><span class='p'>(</span><span class='nx'>i</span><span class='p'>)</span></code> ). On the contrary, when the mouse moves out of a bar, we want to display the default list of circles with the total numbers of messages.</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>gEnter</span><span class='p'>.</span><span class='nx'>append</span><span class='p'>(</span><span class='s1'>&#39;rect&#39;</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;x&#39;</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;y&#39;</span><span class='p'>,</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>){</span> <span class='k'>return</span> <span class='nx'>barMaxHeight</span> <span class='o'>-</span> <span class='nx'>barHeight</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>);</span> <span class='p'>})</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;width&#39;</span><span class='p'>,</span> <span class='nx'>barWidth</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>attr</span><span class='p'>(</span><span class='s1'>&#39;height&#39;</span><span class='p'>,</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>){</span> <span class='k'>return</span> <span class='nx'>barHeight</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>);</span> <span class='p'>})</span>
  <span class='p'>.</span><span class='nx'>style</span><span class='p'>(</span><span class='s1'>&#39;fill&#39;</span><span class='p'>,</span> <span class='nx'>barColorOut</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>style</span><span class='p'>(</span><span class='s1'>&#39;stroke&#39;</span><span class='p'>,</span> <span class='s1'>&#39;white&#39;</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>style</span><span class='p'>(</span><span class='s1'>&#39;stroke-width&#39;</span><span class='p'>,</span> <span class='mi'>1</span><span class='p'>)</span>
  <span class='p'>.</span><span class='nx'>on</span><span class='p'>(</span><span class='s1'>&#39;mouseover&#39;</span><span class='p'>,</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>,</span><span class='nx'>i</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='nx'>d3</span><span class='p'>.</span><span class='nx'>select</span><span class='p'>(</span><span class='k'>this</span><span class='p'>).</span><span class='nx'>transition</span><span class='p'>()</span>
      <span class='p'>.</span><span class='nx'>duration</span><span class='p'>(</span><span class='mi'>100</span><span class='p'>)</span>
      <span class='p'>.</span><span class='nx'>style</span><span class='p'>(</span><span class='s1'>&#39;fill&#39;</span><span class='p'>,</span> <span class='nx'>barColorOn</span><span class='p'>);</span>
    <span class='nx'>showTip</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>,</span> <span class='p'>(</span><span class='nx'>barMaxHeight</span> <span class='o'>-</span> <span class='nx'>barHeight</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>)</span> <span class='o'>-</span> <span class='mi'>30</span><span class='p'>),</span> <span class='p'>(</span><span class='nx'>yAxisWidth</span> <span class='o'>+</span> <span class='nx'>i</span> <span class='o'>*</span> <span class='nx'>barWidth</span> <span class='o'>-</span> <span class='mi'>13</span><span class='p'>));</span>
    <span class='nx'>removeLayer</span><span class='p'>(</span><span class='nx'>currentLayer</span><span class='p'>);</span>	<span class='c1'>// &lt;&lt;-</span>
    <span class='nx'>addLayer</span><span class='p'>(</span><span class='nx'>i</span><span class='p'>);</span>		<span class='c1'>// &lt;&lt;-</span>
  <span class='p'>})</span>
  <span class='p'>.</span><span class='nx'>on</span><span class='p'>(</span><span class='s1'>&#39;mouseout&#39;</span><span class='p'>,</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>,</span><span class='nx'>i</span><span class='p'>){</span>
    <span class='nx'>d3</span><span class='p'>.</span><span class='nx'>select</span><span class='p'>(</span><span class='k'>this</span><span class='p'>).</span><span class='nx'>transition</span><span class='p'>()</span>
      <span class='p'>.</span><span class='nx'>duration</span><span class='p'>(</span><span class='mi'>500</span><span class='p'>)</span>
      <span class='p'>.</span><span class='nx'>style</span><span class='p'>(</span><span class='s1'>&#39;fill&#39;</span><span class='p'>,</span> <span class='nx'>barColorOut</span><span class='p'>);</span>
    <span class='nx'>hideTip</span><span class='p'>();</span>
    <span class='nx'>removeLayer</span><span class='p'>(</span><span class='nx'>i</span><span class='p'>);</span>	<span class='c1'>// &lt;&lt;-</span>
    <span class='nx'>addLayer</span><span class='p'>(</span><span class='mi'>24</span><span class='p'>);</span>	<span class='c1'>// &lt;&lt;-</span>
  <span class='p'>});</span>
</code></pre></div>
<p>Finally, we need to add a legend to the map. As we have two scales of values, we need two different legends and be able to switch between them depending on what is displayed on the map.</p>

<p>Each legend will consist in a <em>div</em>: <code class='highlight'><span class='nt'>div</span><span class='nf'>#legend</span></code> for the total values and <code class='highlight'><span class='nt'>div</span><span class='nf'>#layerLegend</span></code> for the hourly values. Those <em>div</em> are added in the HTML along with the map container.</p>
<div class='highlight'><pre><code class='html'><span class='nt'>&lt;div</span> <span class='na'>id=</span><span class='s'>&quot;content&quot;</span><span class='nt'>&gt;</span>
  <span class='nt'>&lt;div</span> <span class='na'>id=</span><span class='s'>&quot;legend&quot;</span> <span class='na'>style=</span><span class='s'>&#39;display:none&#39;</span><span class='nt'>&gt;</span>
    <span class='nt'>&lt;strong</span> <span class='na'>class=</span><span class='s'>&quot;legend-title&quot;</span><span class='nt'>&gt;</span>Number of messages<span class='nt'>&lt;/strong&gt;</span>
    <span class='nt'>&lt;nav</span> <span class='na'>class=</span><span class='s'>&#39;legend clearfix&#39;</span><span class='nt'>&gt;</span>
      <span class='nt'>&lt;span</span> <span class='na'>style=</span><span class='s'>&#39;background:#f0f9e9&#39;</span><span class='nt'>&gt;&lt;/span&gt;</span>
      <span class='nt'>&lt;span</span> <span class='na'>style=</span><span class='s'>&#39;background:#ccecc7&#39;</span><span class='nt'>&gt;&lt;/span&gt;</span>
      <span class='nt'>&lt;span</span> <span class='na'>style=</span><span class='s'>&#39;background:#a8deb7&#39;</span><span class='nt'>&gt;&lt;/span&gt;</span>
      <span class='nt'>&lt;span</span> <span class='na'>style=</span><span class='s'>&#39;background:#7ecdc4&#39;</span><span class='nt'>&gt;&lt;/span&gt;</span>
      <span class='nt'>&lt;span</span> <span class='na'>style=</span><span class='s'>&#39;background:#4aa2c8&#39;</span><span class='nt'>&gt;&lt;/span&gt;</span>
      <span class='nt'>&lt;span</span> <span class='na'>style=</span><span class='s'>&#39;background:#1d67a9&#39;</span><span class='nt'>&gt;&lt;/span&gt;</span>
    <span class='nt'>&lt;/nav&gt;</span>
    <span class='nt'>&lt;nav</span> <span class='na'>class=</span><span class='s'>&#39;legend cleafix&#39;</span><span class='nt'>&gt;</span>
      <span class='nt'>&lt;label</span> <span class='na'>id=</span><span class='s'>&quot;label1&quot;</span><span class='nt'>&gt;</span>≤ 800<span class='nt'>&lt;/label&gt;</span>
      <span class='nt'>&lt;label</span> <span class='na'>id=</span><span class='s'>&quot;label2&quot;</span><span class='nt'>&gt;</span>&gt; 800<span class='nt'>&lt;/label&gt;</span>
      <span class='nt'>&lt;label</span> <span class='na'>id=</span><span class='s'>&quot;label3&quot;</span><span class='nt'>&gt;</span>&gt; 1600<span class='nt'>&lt;/label&gt;</span>
      <span class='nt'>&lt;label</span> <span class='na'>id=</span><span class='s'>&quot;label4&quot;</span><span class='nt'>&gt;</span>&gt; 4500<span class='nt'>&lt;/label&gt;</span>
      <span class='nt'>&lt;label</span> <span class='na'>id=</span><span class='s'>&quot;label5&quot;</span><span class='nt'>&gt;</span>&gt; 6400<span class='nt'>&lt;/label&gt;</span>
      <span class='nt'>&lt;label</span> <span class='na'>id=</span><span class='s'>&quot;label6&quot;</span><span class='nt'>&gt;</span>&gt; 9600<span class='nt'>&lt;/label&gt;</span>
    <span class='nt'>&lt;/nav&gt;</span>
  <span class='nt'>&lt;/div&gt;</span>
  <span class='nt'>&lt;div</span> <span class='na'>id=</span><span class='s'>&quot;layerLegend&quot;</span> <span class='na'>style=</span><span class='s'>&#39;display:none&#39;</span><span class='nt'>&gt;</span>
    <span class='nt'>&lt;strong</span> <span class='na'>class=</span><span class='s'>&quot;legend-title&quot;</span><span class='nt'>&gt;</span>Number of messages<span class='nt'>&lt;/strong&gt;</span>
   <span class='nt'>&lt;nav</span> <span class='na'>class=</span><span class='s'>&#39;legend clearfix&#39;</span><span class='nt'>&gt;</span>
      <span class='nt'>&lt;span</span> <span class='na'>style=</span><span class='s'>&#39;background:#f0f9e9&#39;</span><span class='nt'>&gt;&lt;/span&gt;</span>
      <span class='nt'>&lt;span</span> <span class='na'>style=</span><span class='s'>&#39;background:#ccecc7&#39;</span><span class='nt'>&gt;&lt;/span&gt;</span>
      <span class='nt'>&lt;span</span> <span class='na'>style=</span><span class='s'>&#39;background:#a8deb7&#39;</span><span class='nt'>&gt;&lt;/span&gt;</span>
      <span class='nt'>&lt;span</span> <span class='na'>style=</span><span class='s'>&#39;background:#7ecdc4&#39;</span><span class='nt'>&gt;&lt;/span&gt;</span>
      <span class='nt'>&lt;span</span> <span class='na'>style=</span><span class='s'>&#39;background:#4aa2c8&#39;</span><span class='nt'>&gt;&lt;/span&gt;</span>
      <span class='nt'>&lt;span</span> <span class='na'>style=</span><span class='s'>&#39;background:#1d67a9&#39;</span><span class='nt'>&gt;&lt;/span&gt;</span>
    <span class='nt'>&lt;/nav&gt;</span>
    <span class='nt'>&lt;nav</span> <span class='na'>class=</span><span class='s'>&#39;legend cleafix&#39;</span><span class='nt'>&gt;</span>
      <span class='nt'>&lt;label</span> <span class='na'>id=</span><span class='s'>&quot;label1&quot;</span><span class='nt'>&gt;</span>≤ 70<span class='nt'>&lt;/label&gt;</span>
      <span class='nt'>&lt;label</span> <span class='na'>id=</span><span class='s'>&quot;label2&quot;</span><span class='nt'>&gt;</span>&gt; 70<span class='nt'>&lt;/label&gt;</span>
      <span class='nt'>&lt;label</span> <span class='na'>id=</span><span class='s'>&quot;label3&quot;</span><span class='nt'>&gt;</span>&gt; 140<span class='nt'>&lt;/label&gt;</span>
      <span class='nt'>&lt;label</span> <span class='na'>id=</span><span class='s'>&quot;label4&quot;</span><span class='nt'>&gt;</span>&gt; 250<span class='nt'>&lt;/label&gt;</span>
      <span class='nt'>&lt;label</span> <span class='na'>id=</span><span class='s'>&quot;label5&quot;</span><span class='nt'>&gt;</span>&gt; 400<span class='nt'>&lt;/label&gt;</span>
      <span class='nt'>&lt;label</span> <span class='na'>id=</span><span class='s'>&quot;label6&quot;</span><span class='nt'>&gt;</span>&gt; 600<span class='nt'>&lt;/label&gt;</span>
    <span class='nt'>&lt;/nav&gt;</span>
  <span class='nt'>&lt;/div&gt;</span>
  <span class='nt'>&lt;div</span> <span class='na'>id=</span><span class='s'>&quot;map&quot;</span><span class='nt'>&gt;&lt;/div&gt;</span>
  <span class='nt'>&lt;div</span> <span class='na'>id=</span><span class='s'>&quot;barchart&quot;</span><span class='nt'>&gt;</span>
    <span class='nt'>&lt;div</span> <span class='na'>id=</span><span class='s'>&quot;tip&quot;</span> <span class='na'>style=</span><span class='s'>&#39;display:none&#39;</span><span class='nt'>&gt;&lt;/div&gt;</span>
  <span class='nt'>&lt;/div&gt;</span>
<span class='nt'>&lt;/div&gt;</span>
</code></pre></div>
<p>By default, naturally we will display the legend of <code class='highlight'><span class='nt'>div</span><span class='nf'>#legend</span></code>.</p>
<div class='highlight'><pre><code class='javascript'><span class='nx'>map</span><span class='p'>.</span><span class='nx'>legendControl</span><span class='p'>.</span><span class='nx'>addLegend</span><span class='p'>(</span><span class='nb'>document</span><span class='p'>.</span><span class='nx'>getElementById</span><span class='p'>(</span><span class='s1'>&#39;legend&#39;</span><span class='p'>).</span><span class='nx'>innerHTML</span><span class='p'>);</span>
</code></pre></div>
<p>We now add two functions to switch the legends.</p>
<div class='highlight'><pre><code class='javascript'><span class='kd'>function</span> <span class='nx'>showLayerLegend</span><span class='p'>()</span> <span class='p'>{</span>
  <span class='nx'>map</span><span class='p'>.</span><span class='nx'>legendControl</span><span class='p'>.</span><span class='nx'>removeLegend</span><span class='p'>(</span><span class='nb'>document</span><span class='p'>.</span><span class='nx'>getElementById</span><span class='p'>(</span><span class='s1'>&#39;legend&#39;</span><span class='p'>).</span><span class='nx'>innerHTML</span><span class='p'>);</span>
  <span class='nx'>map</span><span class='p'>.</span><span class='nx'>legendControl</span><span class='p'>.</span><span class='nx'>addLegend</span><span class='p'>(</span><span class='nb'>document</span><span class='p'>.</span><span class='nx'>getElementById</span><span class='p'>(</span><span class='s1'>&#39;layerLegend&#39;</span><span class='p'>).</span><span class='nx'>innerHTML</span><span class='p'>);</span>
<span class='p'>}</span>

<span class='kd'>function</span> <span class='nx'>hideLayerLegend</span><span class='p'>()</span> <span class='p'>{</span>
  <span class='nx'>map</span><span class='p'>.</span><span class='nx'>legendControl</span><span class='p'>.</span><span class='nx'>removeLegend</span><span class='p'>(</span><span class='nb'>document</span><span class='p'>.</span><span class='nx'>getElementById</span><span class='p'>(</span><span class='s1'>&#39;layerLegend&#39;</span><span class='p'>).</span><span class='nx'>innerHTML</span><span class='p'>);</span>
  <span class='nx'>map</span><span class='p'>.</span><span class='nx'>legendControl</span><span class='p'>.</span><span class='nx'>addLegend</span><span class='p'>(</span><span class='nb'>document</span><span class='p'>.</span><span class='nx'>getElementById</span><span class='p'>(</span><span class='s1'>&#39;legend&#39;</span><span class='p'>).</span><span class='nx'>innerHTML</span><span class='p'>);</span>
<span class='p'>}</span>
</code></pre></div>
<p>And we modify the handlers of the <em>mouseover</em> and <em>mouseout</em> events in the bar chart to effectively switch the legends.</p>
<div class='highlight'><pre><code class='javascript'>  <span class='p'>.</span><span class='nx'>on</span><span class='p'>(</span><span class='s1'>&#39;mouseover&#39;</span><span class='p'>,</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>,</span><span class='nx'>i</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='nx'>d3</span><span class='p'>.</span><span class='nx'>select</span><span class='p'>(</span><span class='k'>this</span><span class='p'>).</span><span class='nx'>transition</span><span class='p'>()</span>
      <span class='p'>.</span><span class='nx'>duration</span><span class='p'>(</span><span class='mi'>100</span><span class='p'>)</span>
      <span class='p'>.</span><span class='nx'>style</span><span class='p'>(</span><span class='s1'>&#39;fill&#39;</span><span class='p'>,</span> <span class='nx'>barColorOn</span><span class='p'>);</span>
    <span class='nx'>showTip</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>,</span> <span class='p'>(</span><span class='nx'>barMaxHeight</span> <span class='o'>-</span> <span class='nx'>barHeight</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>)</span> <span class='o'>-</span> <span class='mi'>30</span><span class='p'>),</span> <span class='p'>(</span><span class='nx'>yAxisWidth</span> <span class='o'>+</span> <span class='nx'>i</span> <span class='o'>*</span> <span class='nx'>barWidth</span> <span class='o'>-</span> <span class='mi'>13</span><span class='p'>));</span>
    <span class='nx'>removeLayer</span><span class='p'>(</span><span class='nx'>currentLayer</span><span class='p'>);</span>
    <span class='nx'>addLayer</span><span class='p'>(</span><span class='nx'>i</span><span class='p'>);</span>
    <span class='nx'>showLayerLegend</span><span class='p'>();</span>	<span class='c1'>// &lt;&lt;-</span>
  <span class='p'>})</span>
  <span class='p'>.</span><span class='nx'>on</span><span class='p'>(</span><span class='s1'>&#39;mouseout&#39;</span><span class='p'>,</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>d</span><span class='p'>,</span><span class='nx'>i</span><span class='p'>){</span>
    <span class='nx'>d3</span><span class='p'>.</span><span class='nx'>select</span><span class='p'>(</span><span class='k'>this</span><span class='p'>).</span><span class='nx'>transition</span><span class='p'>()</span>
      <span class='p'>.</span><span class='nx'>duration</span><span class='p'>(</span><span class='mi'>500</span><span class='p'>)</span>
      <span class='p'>.</span><span class='nx'>style</span><span class='p'>(</span><span class='s1'>&#39;fill&#39;</span><span class='p'>,</span> <span class='nx'>barColorOut</span><span class='p'>);</span>
    <span class='nx'>hideTip</span><span class='p'>();</span>
    <span class='nx'>removeLayer</span><span class='p'>(</span><span class='nx'>i</span><span class='p'>);</span>
    <span class='nx'>addLayer</span><span class='p'>(</span><span class='mi'>24</span><span class='p'>);</span>
    <span class='nx'>hideLayerLegend</span><span class='p'>();</span>	<span class='c1'>// &lt;&lt;-</span>
  <span class='p'>});</span>
</code></pre></div>
<p>And we’re done! Check the full code on <a href="https://github.com/ComplexCity/weibo-qingmingjie">GitHub</a> and the working example in the article <a href="/studies/">Weibo spatial and temporal data</a>.</p>
		</div>
		<div class="post-author">
			<div class="blog-container clearfix">
				<div class="author-photo">
					
						<img src="/assets/authors/laetitia.jpg" class="avatar"/>
					
				</div>
				<div class="author-about">
					<a href="/authors/laetitia-pfaender/" title="Posts by Laëtitia Pfaender" class="author">Laëtitia Pfaender ()</a>
					<p>Laëtitia is a research engineer in computer science.</p>
				</div>
			</div>
		</div>
		
		<div class="blog-container clearfix thin" style="margin-bottom:2em;">
			<div class="left"> 
         
                &laquo; <a href="/2014/05/26/youth-planners-inovation-forum.html" title="Previous Post: Youth Planners' Innovation Forum">Youth Planners' Innovation Forum</a> 
         
        </div> 

        <div class="right"> 
         
                <a href="/2014/06/16/tianzifang-community-or-tourism.html" title="Next Post: Tianzifang: Community or Tourism?">Tianzifang: Community or Tourism?</a> &raquo;
         
        </div> 
		</div>
		
		<div class="blog-container clearfix thin">
		
		
		 <div id="disqus_thread"></div>
		 <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'complexcitylab'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
		</script>
		<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		<a href="http://disqus.com" class="dsq-brlink small">comments powered by <span class="logo-disqus">Disqus</span></a>
    
		
		</div>
	</article>
		
<div class="before-footer center clearfix"></div>
	<footer class="footer clearfix grey">
		<article class="article clearfix">
			<div class="col_100 center clearfix">
				<p class="thin">Complexcity Lab is a collaboration between french Université de Technologie Group and Shanghai University</p>
				<!-- the OFFICIAL CREDIT -->
				<a href="http://interactions.utc.fr/Le-Groupe-UT-avance-en-reseau" alt="UT Group" title="UT Group" class="col_50 center"><img class="img-logo" src="http://localhost:4000/images/logo-3UT.svg" /></a>
				<a href="http://shu.edu.cn" alt="Shanghai University logo black and white" title="go to Shanghai University homepage" class="col_50 center"><img class="img-logo" src="http://localhost:4000/images/logo-SHU-black-SD.png" /></a>
			</div>

			<!-- the LICENCE -->
			<div class="cc thin small">
				<p><a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-nd/3.0/80x15.png" /></a> <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">ComplexCity Laboratory website</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://www.complexcity.org" property="cc:attributionName" rel="cc:attributionURL">ComplexCity Laboratory</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/">Creative Commons Attribution-NonCommercial-NoDerivs 3.0 Unported License</a></p>
				<p><a rel="license" href="http://creativecommons.org/licenses/by/3.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by/3.0/80x15.png" /></a> This website code is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0 Unported License</a></p>
			</div>
		</article>
	</footer>
</body>
</html>